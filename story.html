<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color-scheme: dark;
      --bg: #1e1e1e;
      --card: #2a2a2a;
      --text: #f5f5f5;
      --subtle: #cccccc;
      --primary: #4f8cff;
      --secondary: #444;
      --success: #4fbb6d;
      --used: #555;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100dvh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    main {
      flex: 1;
      max-width: 600px;
      max-height: 100dvh;
      margin: 0 auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
      justify-content: center;
      gap: 1rem;
    }

    .screen.active { display: flex; }

    h1, h2, h3, p {
      color: var(--text);
      text-align: center;
      margin: 0.5rem 0;
    }

    .word-set-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-width: 400px;
      margin: 0 auto;
      width: 100%;
    }

    .word-set-btn {
      padding: 1.25rem;
      font-size: 1.2rem;
      border-radius: 1rem;
      background: var(--card);
      color: var(--text);
      border: 2px solid transparent;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s;
    }

    .word-set-btn:hover {
      border-color: var(--primary);
    }

    .word-set-btn:active {
      transform: scale(0.98);
      background: var(--primary);
    }

    .card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      flex: 1;
      align-content: start;
    }

    .story-card {
      background: var(--card);
      border-radius: 0.75rem;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      user-select: none;
      min-height: 80px;
    }

    .story-card:active {
      transform: scale(0.97);
    }

    .story-card.used {
      background: var(--used);
      opacity: 0.5;
    }

    .story-card.ending {
      grid-column: 1 / 3;
      background: var(--primary);
      font-weight: 600;
    }

    .story-card.ending.used {
      background: var(--secondary);
      opacity: 0.5;
    }

    .card-primary {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    .card-secondary {
      font-size: 0.85rem;
      color: var(--subtle);
      margin-top: 0.25rem;
    }

    .card-category {
      font-size: 0.7rem;
      color: var(--subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
      opacity: 0.7;
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: auto;
    }

    button {
      padding: 1rem;
      font-size: 1.1rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      touch-action: manipulation;
      color: #fff;
    }

    button:active { transform: scale(0.97); }

    .btn-primary { background: var(--primary); }
    .btn-secondary { background: var(--secondary); }

    @media (min-width: 600px) {
      .buttons { flex-direction: row; }
      .buttons button { width: 50%; }
    }
  </style>
</head>
<body>
  <main>
    <!-- Word Set Selection Screen -->
    <section id="screen-select" class="screen active">
      <h1>Story</h1>
      <p>Choose a word set</p>
      <div class="word-set-list" id="word-set-list"></div>
      <div class="buttons">
        <button class="btn-secondary" onclick="goHome()">Back</button>
      </div>
    </section>

    <!-- Game Screen -->
    <section id="screen-game" class="screen">
      <h2>Your Cards</h2>
      <div class="card-grid" id="card-grid"></div>
      <div class="buttons">
        <button class="btn-secondary" id="back-btn" onclick="goToSelect()">New Game</button>
        <button class="btn-primary" onclick="redraw()">Redraw</button>
      </div>
    </section>
  </main>

  <script>
    let wordSets = [];
    let selectedWordSet = null;
    let regularCards = [];
    let endingCards = [];
    let hasMultipleSets = false;

    async function discoverWordSets() {
      const sets = [];
      let i = 1;

      while (true) {
        try {
          const response = await fetch(`word-sets/story-${i}.txt`);
          if (response.ok) {
            const text = await response.text();
            const displayName = `Story Set ${i}`;
            sets.push({ filename: `story-${i}`, displayName });
            i++;
          } else {
            break;
          }
        } catch {
          break;
        }
      }

      return sets;
    }

    async function initWordSetList() {
      const listEl = document.getElementById('word-set-list');
      listEl.innerHTML = '<p>Loading word sets...</p>';

      wordSets = await discoverWordSets();

      listEl.innerHTML = '';

      if (wordSets.length === 0) {
        listEl.innerHTML = '<p>No word sets found</p>';
        return;
      }

      hasMultipleSets = wordSets.length > 1;

      if (wordSets.length === 1) {
        await selectWordSet(wordSets[0].filename);
        return;
      }

      wordSets.forEach(set => {
        const btn = document.createElement('button');
        btn.className = 'word-set-btn';
        btn.textContent = set.displayName;
        btn.onclick = () => selectWordSet(set.filename);
        listEl.appendChild(btn);
      });
    }

    async function selectWordSet(setName) {
      selectedWordSet = setName;
      await loadCards(setName);
      startGame();
    }

    async function loadCards(setName) {
      try {
        const response = await fetch(`word-sets/${setName}.txt`);
        const text = await response.text();
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

        regularCards = [];
        endingCards = [];
        let currentCategory = '';

        for (const line of lines) {
          if (line.startsWith('===')) {
            const match = line.match(/===\s*(\w+)\s*===/);
            if (match) {
              let category = match[1].charAt(0) + match[1].slice(1).toLowerCase();
              if (category.endsWith('s')) {
                category = category.slice(0, -1);
              }
              currentCategory = category;
            }
            continue;
          }

          if (currentCategory === 'Ending') {
            endingCards.push({ primary: line, secondary: null, category: 'Ending' });
          } else if (currentCategory) {
            const parts = line.split(' - ');
            if (parts.length === 2) {
              regularCards.push({ primary: parts[1], secondary: parts[0], category: currentCategory });
            } else {
              regularCards.push({ primary: parts[0], secondary: null, category: currentCategory });
            }
          }
        }

        if (endingCards.length === 0) {
          alert('Error: Word set must contain at least one Ending card');
          regularCards = [];
          return;
        }
      } catch (error) {
        console.error('Failed to load cards:', error);
        regularCards = [{ primary: 'Error', secondary: 'Loading', category: 'Error' }];
        endingCards = [{ primary: 'Error loading endings', secondary: null, category: 'Error' }];
      }
    }

    initWordSetList();

    function goHome() {
      window.location.href = 'index.html';
    }

    function goToScreen(screenId) {
      const screens = document.querySelectorAll('.screen');
      screens.forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function goToSelect() {
      goToScreen('screen-select');
    }

    function shuffle(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function startGame() {
      drawCards();
      const backBtn = document.getElementById('back-btn');
      if (hasMultipleSets) {
        backBtn.textContent = 'New Game';
        backBtn.onclick = goToSelect;
      } else {
        backBtn.textContent = 'Back';
        backBtn.onclick = goHome;
      }
      goToScreen('screen-game');
    }

    function redraw() {
      drawCards();
    }

    function drawCards() {
      const shuffledRegular = shuffle(regularCards);
      const shuffledEndings = shuffle(endingCards);

      const uniqueCategories = new Set(regularCards.map(c => c.category || 'Unknown'));
      const numCategories = uniqueCategories.size;
      const enforceLimit = numCategories >= 3;

      const drawn = [];
      const categoryCount = {};

      for (const card of shuffledRegular) {
        const category = card.category || 'Unknown';
        const count = categoryCount[category] || 0;

        if (!enforceLimit || count < 2) {
          drawn.push(card);
          categoryCount[category] = count + 1;

          if (drawn.length === 6) {
            break;
          }
        }
      }

      if (drawn.length < 6) {
        const remaining = shuffledRegular.slice(0, 6);
        while (drawn.length < 6 && remaining.length > 0) {
          drawn.push(remaining.pop());
        }
      }

      const ending = shuffledEndings[0];

      renderCards(drawn, ending);
    }

    function renderCards(cards, ending) {
      const gridEl = document.getElementById('card-grid');
      gridEl.innerHTML = '';

      cards.forEach((card, index) => {
        const cardEl = createCardElement(card, false);
        gridEl.appendChild(cardEl);
      });

      const endingEl = createCardElement(ending, true);
      gridEl.appendChild(endingEl);
    }

    function createCardElement(card, isEnding) {
      const cardEl = document.createElement('div');
      cardEl.className = isEnding ? 'story-card ending' : 'story-card';

      const categoryEl = document.createElement('div');
      categoryEl.className = 'card-category';
      categoryEl.textContent = card.category || '';
      cardEl.appendChild(categoryEl);

      const primaryEl = document.createElement('div');
      primaryEl.className = 'card-primary';
      primaryEl.textContent = card.primary;
      cardEl.appendChild(primaryEl);

      if (card.secondary) {
        const secondaryEl = document.createElement('div');
        secondaryEl.className = 'card-secondary';
        secondaryEl.textContent = card.secondary;
        cardEl.appendChild(secondaryEl);
      }

      cardEl.onclick = () => {
        cardEl.classList.toggle('used');
      };

      return cardEl;
    }
  </script>
</body>
</html>
